<?php
get_header();

if ( have_posts() ) :
while ( have_posts() ) : the_post();

/* ===========================================================
   DIVE SITE META FIELDS (CMB2)
=========================================================== */
$destination_time = get_post_meta( get_the_ID(), 'destination_time', true );
$highlights       = get_post_meta( get_the_ID(), 'highlights', true );
$best_for         = get_post_meta( get_the_ID(), 'best_for', true );

/* ===========================================================
   MAP IMAGE (ATTACHMENT ID ONLY – SAFE)
=========================================================== */
$map_image_id = get_post_meta( get_the_ID(), 'dive_site_image_id', true );
$dive_gallery = get_post_meta( get_the_ID(), 'dive_site_gallery', true );


$map_image = $map_image_id
    ? wp_get_attachment_image(
        $map_image_id,
        'full',
        false,
        array(
            'class' => 'w-full h-full object-contain skip-easy-io',
            'loading' => 'lazy'
        )
    )
    : '';
?>

<article class="py-20 lg:py-36">

<main class="container px-4 sm:px-10 max-w-screen-2xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-14 items-start">

    <!-- ================= LEFT SIDE : CONTENT ================= -->
    <div class="space-y-10">

        <!-- TITLE -->
        <h3 class="page-title font-body text-sm font-normal text-smoke-white-900 uppercase tracking-wider">Dive Sites</h3>
        <h1 class="font-title text-5xl sm:text-7xl font-extralight text-paradise-pink-500">
            <?php the_title(); ?>
        </h1>

        <!-- TO DESTINATION -->
        <?php if ( $destination_time ) : ?>
        <div class="flex gap-4 items-start">
            <div class="icon-circle">
                <!-- CLOCK -->
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg"
                     fill="none" viewBox="0 0 24 24"
                     stroke="#1f4f66" stroke-width="1.8"> 
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div>
                <h4 class="font-bold text-gray-800 mb-1">To Destination</h4>
                <p class="text-gray-700">
                    <?php echo esc_html( $destination_time ); ?>
                </p>
            </div>
        </div>
        <?php endif; ?>

        <!-- HIGHLIGHTS -->
        <?php if ( $highlights ) : ?>
        <div class="flex gap-4 items-start">
            <div class="icon-circle">
                <!-- STAR / HIGHLIGHT -->
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg"
                     fill="none" viewBox="0 0 24 24"
                     stroke="#1f4f66" stroke-width="1.8">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 3v18M3 12h18M5.5 5.5l13 13M18.5 5.5l-13 13"/>
                </svg>
            </div>
            <div>
                <h4 class="font-bold text-gray-800 mb-1">Highlights</h4>
                <p class="text-gray-700">
                    <?php echo nl2br( esc_html( $highlights ) ); ?>
                </p>
            </div>
        </div>
        <?php endif; ?>


        <!-- BEST FOR -->
        <?php if ( $best_for ) : ?>
        <div class="flex gap-4 items-start">
            <div class="icon-circle">
                <!-- THUMBS UP -->
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-svg"
                     fill="none" viewBox="0 0 24 24"
                     stroke="#1f4f66" stroke-width="1.8">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M14 9V5a3 3 0 00-6 0v4m-4 4h16l-1.5 8h-13L4 13z"/>
                </svg>



                <svg fill="#1f4f66" width="800px" height="800px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21.3,10.08A3,3,0,0,0,19,9H14.44L15,7.57A4.13,4.13,0,0,0,11.11,2a1,1,0,0,0-.91.59L7.35,9H5a3,3,0,0,0-3,3v7a3,3,0,0,0,3,3H17.73a3,3,0,0,0,2.95-2.46l1.27-7A3,3,0,0,0,21.3,10.08ZM7,20H5a1,1,0,0,1-1-1V12a1,1,0,0,1,1-1H7Zm13-7.82-1.27,7a1,1,0,0,1-1,.82H9V10.21l2.72-6.12A2.11,2.11,0,0,1,13.1,6.87L12.57,8.3A2,2,0,0,0,14.44,11H19a1,1,0,0,1,.77.36A1,1,0,0,1,20,12.18Z"/></svg>
            </div>
            <div>
                <h4 class="font-bold text-gray-800 mb-1">Best For</h4>
                <p class="text-gray-700">
                    <?php echo esc_html( $best_for ); ?>
                </p>
            </div>
        </div>
        <?php endif; ?>

        <!-- MAIN CONTENT -->
        <div class="prose max-w-none text-gray-700 pt-4">
            <?php the_content(); ?>
        </div>

    </div>

    <!-- ================= RIGHT SIDE : MAP ================= -->
    <aside class="w-full h-full flex items-center justify-center">
        <?php echo $map_image; ?>
    </aside>

</main>

</article>
<?php if ( ! empty( $dive_gallery ) && is_array( $dive_gallery ) ) : ?>

<section class="pb-20">
  <div class="carousel-wrapper">
    <div class="carousel js-flickity"
         data-flickity='{
           "cellAlign": "left",
           "contain": true,
           "wrapAround": true,
           "pageDots": false,
           "prevNextButtons": true,
           "lazyLoad": 3,
           "imagesLoaded": true
         }'>

      <?php foreach ( $dive_gallery as $attachment_id => $attachment_url ) : ?>
        <?php
          $img = wp_get_attachment_image_url( $attachment_id, 'large' );
          if ( ! $img ) continue;
        ?>
        <div class="carousel-cell">
          <img data-flickity-lazyload="<?php echo esc_url( $img ); ?>" alt="">
        </div>
      <?php endforeach; ?>

    </div>
  </div>
</section>


<?php endif; ?>


<?php

$current_id = get_the_ID();

$args = array (
    'post_type'      => 'dive-site',
    'post__not_in'   => array( $current_id ),
    'posts_per_page' => -1
);

$dive_sites = new WP_Query( $args );

if ( $dive_sites->have_posts() ) :
?>

<section class="py-8 md:py-20">
    <div class="container px-4 sm:px-10 max-w-screen-xl mx-auto grid grid-cols-1 sm:grid-cols-5 gap-y-8 mb-8">
        <h3 class="col-span-1 sm:col-span-2 text-3xl sm:text-4xl font-title font-extralight text-sapphire-blue-500 max-w-md">
            Explore More Dive Sites
        </h3>
    </div>

    <div class="offers-carousel container px-4 sm:px-10 max-w-screen-xl mx-auto relative">

        <div class="swiper swiper-x">
            <div class="swiper-wrapper">

                <?php while ( $dive_sites->have_posts() ) :
                    $dive_sites->the_post();

                    $map_id = get_post_meta( get_the_ID(), 'dive_site_image_id', true );
                ?>

                <div class="item-card swiper-slide">
                    <a href="<?php the_permalink(); ?>" class="group">

                        <figure class="w-full aspect-[334/384] bg-white overflow-hidden relative">

                            <?php
                            if ( $map_id ) {
                                echo wp_get_attachment_image(
                                    $map_id,
                                    'full',
                                    false,
                                    array(
                                        'class' => 'w-full h-full object-contain skip-easy-io'
                                    )
                                );
                            }
                            ?>

                            <div class="absolute bottom-0 left-0 w-full h-1/2 flex flex-col justify-end bg-gradient-to-t from-white/90 to-white/0">
                                <div class="p-6">
                                    <h3 class="text-2xl font-title font-extralight text-paradise-pink-500">
                                        <?php the_title(); ?>
                                    </h3>
                                </div>
                            </div>

                        </figure>
                    </a>
                </div>

                <?php endwhile; wp_reset_postdata(); ?>

            </div>
        </div>

        <!-- ✅ SAME ARROWS AS OFFERS -->
        <div class="next-arrow group absolute p-4 top-1/3 lg:top-5 -right-3 lg:-right-2 xl:-right-8 z-20 transition-all duration-150 ease-out">
            <svg width="99" height="10" viewBox="0 0 99 10" xmlns="http://www.w3.org/2000/svg"
                 class="text-sapphire-blue-500 group-hover:text-sapphire-blue-900">
                <path d="M93.6245 0.219107L98.61 4.2075C98.8472 4.39035 99 4.67731 99 4.99996
                C99 5.32262 98.8472 5.60958 98.61 5.79243L93.6245 9.78082
                C93.1933 10.1258 92.564 10.0559 92.2189 9.62464
                C91.8739 9.19338 91.9439 8.56409 92.3751 8.21908
                L95.149 5.99996H1C0.447715 5.99996 0 5.55225 0 4.99996
                C0 4.44768 0.447715 3.99996 1 3.99996H95.149
                L92.3751 1.78084C91.9439 1.43584 91.8739 0.806543
                92.2189 0.375281C92.564 -0.0559811 93.1933 -0.125903
                93.6245 0.219107Z" fill="currentColor"/>
            </svg>
        </div>

        <div class="prev-arrow group absolute p-4 bottom-1/3 lg:bottom-5 -left-3 lg:-left-2 xl:-left-8 z-20 transition-all duration-150 ease-out">
            <svg width="99" height="10" viewBox="0 0 99 10" xmlns="http://www.w3.org/2000/svg"
                 class="text-sapphire-blue-500 group-hover:text-sapphire-blue-900">
                <path d="M5.37549 0.219107L0.389992 4.2075C0.152802 4.39035 0 4.67731
                0 4.99996C0 5.32262 0.152809 5.60958 0.390007 5.79243
                L5.37549 9.78082C5.80675 10.1258 6.43604 10.0559
                6.78105 9.62464C7.12606 9.19338 7.05614 8.56409
                6.62488 8.21908L3.85098 5.99996H98
                C98.5523 5.99996 99 5.55225 99 4.99996
                C99 4.44768 98.5523 3.99996 98 3.99996
                H3.85098L6.62488 1.78084
                C7.05614 1.43584 7.12606 0.806543
                6.78105 0.375281C6.43604 -0.0559811
                5.80675 -0.125903 5.37549 0.219107Z" fill="currentColor"/>
            </svg>
        </div>

    </div>
</section>
<script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>

<?php endif; ?>





<style>
/* =========================================
   DIVE SITE CAROUSEL FIXES
========================================= */
.carousel-wrapper {
    max-width: 1200px;  
    margin: 0 auto;
    padding: 0 20px;
}

.offers-carousel {
    overflow: visible !important;
}

.offers-carousel .swiper {
    overflow: visible;
}

.offers-carousel .swiper-slide {
    width: 420px; 
}

/* Arrow visibility */
.offers-carousel .next-arrow,
.offers-carousel .prev-arrow {
    opacity: 1;
    pointer-events: auto;
}

/* Mobile tweak */
@media (max-width: 768px) {
    .offers-carousel .swiper-slide {
        width: 300px;
    }
}


/* ======================================
   ICON STYLE (CONSISTENT)
====================================== */
.icon-circle{
    width:40px;
    height:40px;
    border-radius:9999px;
    background:#EAF4F7;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 1px 2px rgba(0,0,0,0.05);
    flex-shrink:0;
}
.icon-svg{
    width:20px;
    height:20px;
}


.carousel {
      background: #FAFAFA;
    max-width: 1400px;
    margin: 0 auto;
}

.carousel-cell img {
    width: 100%;
    height: 400px;
    object-fit: cover;
    display: block;
}


/* ===== FLICKITY CELLS ===== */
.carousel-cell {
    width: calc(100% / 3);  /* ✅ EXACTLY 3 */
    padding-right: 20px;
    box-sizing: border-box;
}

/* Lazy loaded */
.carousel-cell-image.flickity-lazyloaded,
.carousel-cell-image.flickity-lazyerror {
    opacity: 1;
}

/* Tablet */
@media (max-width: 1024px) {
    .carousel-cell {
        width: calc(100% / 2);
    }
    .carousel-cell img {
        height: 320px;
    }
}

/* Mobile */
@media (max-width: 640px) {
    .carousel-cell {
        width: 85%;
    }
    .carousel-cell img {
        height: 260px;
    }
}

</style>

<script>
document.addEventListener('DOMContentLoaded', function () {

    new Swiper('.swiper-x', {
        slidesPerView: 'auto',
        spaceBetween: 40,
        centeredSlides: false,
        loop: false,
        navigation: {
            nextEl: '.next-arrow',
            prevEl: '.prev-arrow',
        },
        breakpoints: {
            768: {
                spaceBetween: 60,
            }
        }
    });

});
</script>


<?php
endwhile;
endif;

get_footer();